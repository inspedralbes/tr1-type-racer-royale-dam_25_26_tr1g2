version: "3.9"

services:
  # -------------------------------------------------------------
  # Database Service
  # -------------------------------------------------------------
  db:
    image: mariadb:12
    container_name: fitai_db
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: fitai_db
      MYSQL_USER: fitai_user
      MYSQL_PASSWORD: fitai_pass
    volumes:
      - db_data:/var/lib/mysql
      - ./backend/schema.sql:/docker-entrypoint-initdb.d/schema.sql:ro

  # -------------------------------------------------------------
  # Backend Service
  # -------------------------------------------------------------
  backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile.prod
    container_name: tr1-backend
    restart: always
    environment:
      DB_HOST: db
      DB_PORT: 3306
      DB_USER: fitai_user
      DB_PASSWORD: fitai_pass
      DB_NAME: fitai_db
      API_PORT: 9000
      WS_PORT: 8082
      # AHORA CAMBIAMOS A HTTPS EN LOS ORÍGENES
      FRONTEND_ORIGINS: "https://trainai.dam.inspedralbes.cat,http://localhost"
    depends_on:
      - db
    networks:
      - trainai-net

  # -------------------------------------------------------------
  # Frontend Service (Builder)
  # -------------------------------------------------------------
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.prod
      args:
        # API AHORA EN HTTPS
        VITE_API_URL: "https://trainai.dam.inspedralbes.cat/api"
    container_name: tr1-frontend-build
    volumes:
      - frontend_static:/app/dist
    restart: "no"
    networks:
      - trainai-net

  # -------------------------------------------------------------
  # Reverse Proxy (Nginx + SSL)
  # -------------------------------------------------------------
  proxy:
    image: nginx:stable-alpine
    container_name: tr1-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./proxy/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - frontend_static:/usr/share/nginx/html:ro
      # Volúmenes compartidos con Certbot
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    depends_on:
      - backend
      - frontend
    # Comando para recargar configuración de Nginx cada 6h (para renovaciones)
    command: '/bin/sh -c ''while :; do sleep 6h & wait $${!}; nginx -s reload; done & nginx -g "daemon off;"'''
    networks:
      - trainai-net

  # -------------------------------------------------------------
  # Certbot (Gestor de certificados)
  # -------------------------------------------------------------
  certbot:
    image: certbot/certbot
    container_name: tr1-certbot
    restart: unless-stopped
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # Revisa renovación cada 12 horas
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

volumes:
  db_data:
  frontend_static:

networks:
  trainai-net:
    driver: bridge